!function(e){var t={};function i(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(n,o,function(t){return e[t]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return o}));var n=i(1);function o(e,t){this.playerElem=e,this.listElem=t,this.room=new n.default,this.listeners=[],this.addEventListener=(e,t)=>{this.listeners.push({event:e,cb:t})},this.emit=(e,...t)=>{this.listeners.forEach((i,n)=>{i.event===e&&i.cb(...t)})},this.setVolume=e=>{this.playerElem.volume=e||1},this.loadFromEvent=e=>{let t=!1;this.parsers.forEach((i,n)=>{if(t)return null;let o=i.parser,a=i.action;o(e)&&(t=!0,a(e))})},this.isThread=e=>e.match(/2ch\..*\/[A-z]+\/res\/[0-9]+\.html$/),this.isVideo=e=>e.match(/2ch\..*\/[A-z]+\/src\/[0-9]+\/[0-9]+\.(webm|mp4)$/),this.fetchVideos=async e=>fetch("/api/getvideos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}).catch(e=>console.log(e)).then(e=>e.json().then(e=>(localStorage.setItem("videos",JSON.stringify(e)),e))),this.renderList=async e=>{this.listElem.textContent="",e.forEach(async e=>{let t=document.createElement("a"),i=document.createElement("img");return t.className="preview",t.href=e.video,i.src=e.preview,i.loading="lazy",t.appendChild(i),this.listElem.appendChild(t),t.onclick=t=>{t.preventDefault(),t.target.className="viewed",this.setVideo(e.video)},await new Promise(async e=>{setTimeout(e,100)})})},this.loadFromLocalStorage=()=>{let e;(e=localStorage.getItem("videos"))&&(e=JSON.parse(e),this.renderList(e))},this.loadThread=async e=>{let t=await this.fetchVideos(e);return await this.renderList(t)},this.setVideo=e=>{try{this.room.setRoomVideo(e),this.playerElem.src=e,this.emit("videochanged",e)}catch(e){throw new Error("Ошибка при смене адреса видео")}},this.setVideoNotManually=e=>{try{this.playerElem.src=e}catch(e){throw new Error("Ошибка при смене адреса видео")}},this.init=async()=>{let e=await this.room.fetchRoomByName();this.setVideoNotManually(e.video)},this.play=(e=!1)=>(e&&(o.stopPausePlayEvents=!0),this.playerElem.play()),this.pause=(e=!1)=>(e&&(o.stopPausePlayEvents=!0),this.playerElem.pause()),this.currentTime=()=>this.playerElem.currentTime,this.setTime=e=>this.playerElem.currentTime=e,this.src=()=>this.playerElem.src;this.parsers=[{parser:this.isThread,action:this.loadThread},{parser:this.isVideo,action:this.setVideo}]}},function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return n}));class n{constructor(e="main"){this.name=this.extractNameFromLocation()||"main"}extractNameFromLocation(){let e=window.location.href.match(/room\/([0-9]*)/);return e?e[1]:null}async fetchRoomByName(){let e=this.name,t=await fetch("/api/getRoomByName",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});return await t.json()}async setRoomVideo(e){let t=this.name,i=await fetch("/api/setRoomVideo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,url:e})});return await i.json()}}},function(e,t,i){"use strict";i.r(t),i.d(t,"socket",(function(){return o})),i.d(t,"PlayerInstance",(function(){return d}));var n=i(0);const o=io.connect(window.location.origin);let a=document.getElementById("video_load_form"),r=a.load_button,s=a.url,l=document.getElementById("videolist"),c=document.getElementById("player");const d=new n.default(c,l);r.addEventListener("click",e=>{let t=s.value;s.value="",d.loadFromEvent(t)}),d.setVolume(.1),d.loadFromLocalStorage(),o.on("connect",()=>{d.init(),o.on("videochanged",e=>{d.setVideoNotManually(e)}),o.on("videoplayed",async(e,t)=>{d.src()===t&&(d.setTime(e),await d.play(!0))}),o.on("videopaused",e=>{d.src()===e&&d.pause(!0)})}),d.addEventListener.call(d,"videochanged",e=>{o.emit("videochanged",e)}),d.playerElem.addEventListener("play",e=>{try{if(!n.default.stopPausePlayEvents){let e=d.src(),t=d.currentTime();o.emit("videoplayed",t,e)}}finally{n.default.stopPausePlayEvents=!1}}),d.playerElem.addEventListener("pause",e=>{try{if(!n.default.stopPausePlayEvents){let e=d.src();o.emit("videopaused",e)}}finally{n.default.stopPausePlayEvents=!1}}),window.onunload=window.onbeforeunload=()=>{o.close()}}]);